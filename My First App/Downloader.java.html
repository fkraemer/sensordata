<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<title>Downloader.java</title>
<meta name="Generator" content="SciTE - www.Scintilla.org">
<style type="text/css">
.S0 {
	color: #808080;
}
.S1 {
	font-family: 'Lucida Sans Typewriter';
	color: #009700;
	background: #FEFEFE;
	text-decoration: inherit;
	font-size: 9pt;
}
.S3 {
	font-family: 'Lucida Sans Typewriter';
	color: #009700;
	background: #FEFEFE;
	text-decoration: inherit;
	font-size: 9pt;
}
.S4 {
	color: #007F7F;
}
.S5 {
	font-weight: bold;
	color: #205EF3;
}
.S6 {
	color: #B1009B;
}
.S10 {
	font-weight: bold;
	color: #000000;
}
.S18 {
	font-family: 'Lucida Sans Typewriter';
	color: #804020;
	font-size: 9pt;
}
span {
	font-family: 'Lucida Sans Typewriter';
	color: #000000;
	font-size: 9pt;
}
</style>
</head>
<body bgcolor="#FFFFFF">
<span><span class="S3">/**</span><br>
<span class="S3">&nbsp;* Downloader.java</span><br>
<span class="S3">&nbsp;* Copyright 2008 Zach Scrivena</span><br>
<span class="S3">&nbsp;* zachscrivena@gmail.com</span><br>
<span class="S3">&nbsp;* http://zs.freeshell.org/</span><br>
<span class="S3">&nbsp;*</span><br>
<span class="S3">&nbsp;* TERMS AND CONDITIONS:</span><br>
<span class="S3">&nbsp;* This program is free software: you can redistribute it and/or modify</span><br>
<span class="S3">&nbsp;* it under the terms of the GNU General Public License as published by</span><br>
<span class="S3">&nbsp;* the Free Software Foundation, either version 3 of the License, or</span><br>
<span class="S3">&nbsp;* (at your option) any later version.</span><br>
<span class="S3">&nbsp;*</span><br>
<span class="S3">&nbsp;* This program is distributed in the hope that it will be useful,</span><br>
<span class="S3">&nbsp;* but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br>
<span class="S3">&nbsp;* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. &nbsp;See the</span><br>
<span class="S3">&nbsp;* GNU General Public License for more details.</span><br>
<span class="S3">&nbsp;*</span><br>
<span class="S3">&nbsp;* You should have received a copy of the GNU General Public License</span><br>
<span class="S3">&nbsp;* along with this program. &nbsp;If not, see &lt;http://www.gnu.org/licenses/&gt;.</span><br>
<span class="S3">&nbsp;*/</span><br>
<br>
<span class="S5">package</span><span class="S0"> </span>org<span class="S10">.</span>freeshell<span class="S10">.</span>zs<span class="S10">.</span>common<span class="S10">;</span><br>
<br>
<span class="S5">import</span><span class="S0"> </span>java<span class="S10">.</span>io<span class="S10">.</span>BufferedInputStream<span class="S10">;</span><br>
<span class="S5">import</span><span class="S0"> </span>java<span class="S10">.</span>io<span class="S10">.</span>BufferedOutputStream<span class="S10">;</span><br>
<span class="S5">import</span><span class="S0"> </span>java<span class="S10">.</span>io<span class="S10">.</span>BufferedReader<span class="S10">;</span><br>
<span class="S5">import</span><span class="S0"> </span>java<span class="S10">.</span>io<span class="S10">.</span>Closeable<span class="S10">;</span><br>
<span class="S5">import</span><span class="S0"> </span>java<span class="S10">.</span>io<span class="S10">.</span>File<span class="S10">;</span><br>
<span class="S5">import</span><span class="S0"> </span>java<span class="S10">.</span>io<span class="S10">.</span>FileOutputStream<span class="S10">;</span><br>
<span class="S5">import</span><span class="S0"> </span>java<span class="S10">.</span>io<span class="S10">.</span>InputStream<span class="S10">;</span><br>
<span class="S5">import</span><span class="S0"> </span>java<span class="S10">.</span>io<span class="S10">.</span>InputStreamReader<span class="S10">;</span><br>
<span class="S5">import</span><span class="S0"> </span>java<span class="S10">.</span>net<span class="S10">.</span>URL<span class="S10">;</span><br>
<span class="S5">import</span><span class="S0"> </span>java<span class="S10">.</span>net<span class="S10">.</span>URLConnection<span class="S10">;</span><br>
<span class="S5">import</span><span class="S0"> </span>java<span class="S10">.</span>util<span class="S10">.</span>Locale<span class="S10">;</span><br>
<span class="S5">import</span><span class="S0"> </span>java<span class="S10">.</span>util<span class="S10">.</span>regex<span class="S10">.</span>Matcher<span class="S10">;</span><br>
<span class="S5">import</span><span class="S0"> </span>java<span class="S10">.</span>util<span class="S10">.</span>regex<span class="S10">.</span>Pattern<span class="S10">;</span><br>
<br>
<br>
<span class="S3">/**</span><br>
<span class="S3">&nbsp;* Download a remote resource.</span><br>
<span class="S3">&nbsp;*/</span><br>
<span class="S5">public</span><span class="S0"> </span><span class="S5">class</span><span class="S0"> </span>Downloader<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">implements</span><span class="S0"> </span>Runnable<br>
<span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/** wait interval in milliseconds (100) */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">private</span><span class="S0"> </span><span class="S5">static</span><span class="S0"> </span><span class="S5">final</span><span class="S0"> </span><span class="S5">long</span><span class="S0"> </span>WAIT_INTERVAL_MILLISECONDS<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S4">100L</span><span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/** buffer size in number of bytes (1024) */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">private</span><span class="S0"> </span><span class="S5">static</span><span class="S0"> </span><span class="S5">final</span><span class="S0"> </span><span class="S5">int</span><span class="S0"> </span>BUFFER_SIZE<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S4">1024</span><span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/** URL of the remote resource to be downloaded */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">private</span><span class="S0"> </span><span class="S5">final</span><span class="S0"> </span>URL<span class="S0"> </span>url<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/** target object to be populated */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">private</span><span class="S0"> </span><span class="S5">final</span><span class="S0"> </span>Object<span class="S0"> </span>target<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/** length of the remote resource, in number of bytes; -1 if unknown */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">private</span><span class="S0"> </span><span class="S5">int</span><span class="S0"> </span>totalLength<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S10">-</span><span class="S4">1</span><span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/** number of bytes downloaded */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">private</span><span class="S0"> </span><span class="S5">int</span><span class="S0"> </span>downloadedLength<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S4">0</span><span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/** mutex lock for fields totalLength and downloadedLength */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">private</span><span class="S0"> </span><span class="S5">final</span><span class="S0"> </span>Object<span class="S0"> </span>lengthLock<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S5">new</span><span class="S0"> </span>Object<span class="S10">();</span><br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/** string describing the current progress */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">volatile</span><span class="S0"> </span><span class="S5">private</span><span class="S0"> </span>String<span class="S0"> </span>progressString<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S6">"Waiting to start"</span><span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/** has there been an update in the progress? */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">volatile</span><span class="S0"> </span><span class="S5">private</span><span class="S0"> </span><span class="S5">boolean</span><span class="S0"> </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>false<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/** Exception object representing the error, if any */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">volatile</span><span class="S0"> </span><span class="S5">private</span><span class="S0"> </span>Exception<span class="S0"> </span>error<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S5">null</span><span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/** has the download started? */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">private</span><span class="S0"> </span><span class="S5">boolean</span><span class="S0"> </span>started<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>false<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/** is the downloader running? */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">private</span><span class="S0"> </span><span class="S5">boolean</span><span class="S0"> </span>running<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>false<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/** is the download cancelled? */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">private</span><span class="S0"> </span><span class="S5">boolean</span><span class="S0"> </span>cancelled<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>false<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/** is the download completed? */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">private</span><span class="S0"> </span><span class="S5">boolean</span><span class="S0"> </span>completed<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>false<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/** mutex lock for fields started, running, cancelled, and completed */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">private</span><span class="S0"> </span><span class="S5">final</span><span class="S0"> </span>Object<span class="S0"> </span>stateLock<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S5">new</span><span class="S0"> </span>Object<span class="S10">();</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Constructor.</span><br>
<span class="S3">&nbsp; &nbsp;  * The target object should not be accessed until after calling waitUntilCompleted().</span><br>
<span class="S3">&nbsp; &nbsp;  *</span><br>
<span class="S3">&nbsp; &nbsp;  * </span><span class="S18">@param</span><span class="S3"> url</span><br>
<span class="S3">&nbsp; &nbsp;  * &nbsp;&nbsp;&nbsp;&nbsp;URL of the remote resource to be downloaded</span><br>
<span class="S3">&nbsp; &nbsp;  * </span><span class="S18">@param</span><span class="S3"> target</span><br>
<span class="S3">&nbsp; &nbsp;  * &nbsp;&nbsp;&nbsp;&nbsp;target object to be populated (File or StringBuilder object)</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">public</span><span class="S0"> </span>Downloader<span class="S10">(</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">final</span><span class="S0"> </span>URL<span class="S0"> </span>url<span class="S10">,</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">final</span><span class="S0"> </span>Object<span class="S0"> </span>target<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">((</span>target<span class="S0"> </span><span class="S5">instanceof</span><span class="S0"> </span>File<span class="S10">)</span><span class="S0"> </span><span class="S10">||</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">(</span>target<span class="S0"> </span><span class="S5">instanceof</span><span class="S0"> </span>StringBuilder<span class="S10">))</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">this</span><span class="S10">.</span>target<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>target<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">else</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">throw</span><span class="S0"> </span><span class="S5">new</span><span class="S0"> </span>IllegalArgumentException<span class="S10">(</span><span class="S6">"Target must be a File or StringBuilder object."</span><span class="S10">);</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">this</span><span class="S10">.</span>url<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>url<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>stateLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>started<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>false<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>running<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>false<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Get the length of the remote resource.</span><br>
<span class="S3">&nbsp; &nbsp;  *</span><br>
<span class="S3">&nbsp; &nbsp;  * </span><span class="S18">@return</span><br>
<span class="S3">&nbsp; &nbsp;  * &nbsp;&nbsp;&nbsp;&nbsp;length of the remote resource, in number of bytes; -1 if &nbsp;unknown</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">public</span><span class="S0"> </span><span class="S5">int</span><span class="S0"> </span>getLength<span class="S10">()</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>lengthLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S0"> </span>totalLength<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Get the number of bytes downloaded.</span><br>
<span class="S3">&nbsp; &nbsp;  *</span><br>
<span class="S3">&nbsp; &nbsp;  * </span><span class="S18">@return</span><br>
<span class="S3">&nbsp; &nbsp;  * &nbsp;&nbsp;&nbsp;&nbsp;number of bytes downloaded</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">public</span><span class="S0"> </span><span class="S5">int</span><span class="S0"> </span>getDownloadedLength<span class="S10">()</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>lengthLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S0"> </span>downloadedLength<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Get a string describing the current progress.</span><br>
<span class="S3">&nbsp; &nbsp;  *</span><br>
<span class="S3">&nbsp; &nbsp;  * </span><span class="S18">@return</span><br>
<span class="S3">&nbsp; &nbsp;  * &nbsp;&nbsp;&nbsp;&nbsp;string describing the current progress</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">public</span><span class="S0"> </span>String<span class="S0"> </span>getProgressString<span class="S10">()</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S0"> </span>progressString<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Get the percentage describing the current progress.</span><br>
<span class="S3">&nbsp; &nbsp;  *</span><br>
<span class="S3">&nbsp; &nbsp;  * </span><span class="S18">@return</span><br>
<span class="S3">&nbsp; &nbsp;  * &nbsp;&nbsp;&nbsp;&nbsp;percentage describing the current progress; -1 if unknown</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">public</span><span class="S0"> </span><span class="S5">int</span><span class="S0"> </span>getProgressPercent<span class="S10">()</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>lengthLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">((</span>totalLength<span class="S0"> </span><span class="S10">&lt;=</span><span class="S0"> </span><span class="S4">0</span><span class="S10">)</span><span class="S0"> </span><span class="S10">||</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">(</span>downloadedLength<span class="S0"> </span><span class="S10">&gt;</span><span class="S0"> </span>totalLength<span class="S10">))</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S0"> </span><span class="S10">-</span><span class="S4">1</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">else</span><span class="S0"> </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>downloadedLength<span class="S0"> </span><span class="S10">==</span><span class="S0"> </span>totalLength<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S0"> </span><span class="S4">100</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">else</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S0"> </span><span class="S10">(</span><span class="S5">int</span><span class="S10">)</span><span class="S0"> </span><span class="S10">(</span><span class="S4">100.0</span><span class="S0"> </span><span class="S10">*</span><span class="S0"> </span>downloadedLength<span class="S0"> </span><span class="S10">/</span><span class="S0"> </span>totalLength<span class="S10">);</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Has there been an update in the progress?</span><br>
<span class="S3">&nbsp; &nbsp;  * The progressUpdated flag is set to false before this method returns.</span><br>
<span class="S3">&nbsp; &nbsp;  *</span><br>
<span class="S3">&nbsp; &nbsp;  * </span><span class="S18">@return</span><br>
<span class="S3">&nbsp; &nbsp;  * &nbsp;&nbsp;&nbsp;&nbsp;true if there has been an update in the progress; false otherwise</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">public</span><span class="S0"> </span><span class="S5">boolean</span><span class="S0"> </span>isProgressUpdated<span class="S10">()</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>progressUpdated<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>false<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S0"> </span>true<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">else</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S0"> </span>false<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Pause the download.</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">public</span><span class="S0"> </span><span class="S5">void</span><span class="S0"> </span>pause<span class="S10">()</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>stateLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>running<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>false<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Resume the download.</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">public</span><span class="S0"> </span><span class="S5">void</span><span class="S0"> </span>resume<span class="S10">()</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>stateLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(!</span>completed<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>running<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Cancel the download.</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">public</span><span class="S0"> </span><span class="S5">void</span><span class="S0"> </span>cancel<span class="S10">()</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>stateLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>cancelled<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Has the download started?</span><br>
<span class="S3">&nbsp; &nbsp;  *</span><br>
<span class="S3">&nbsp; &nbsp;  * </span><span class="S18">@return</span><br>
<span class="S3">&nbsp; &nbsp;  * &nbsp;&nbsp;&nbsp;&nbsp;true if download has started; false otherwise</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">public</span><span class="S0"> </span><span class="S5">boolean</span><span class="S0"> </span>isStarted<span class="S10">()</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>stateLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S0"> </span>started<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Is the downloader running?</span><br>
<span class="S3">&nbsp; &nbsp;  *</span><br>
<span class="S3">&nbsp; &nbsp;  * </span><span class="S18">@return</span><br>
<span class="S3">&nbsp; &nbsp;  * &nbsp;&nbsp;&nbsp;&nbsp;true if downloader is running; false otherwise</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">public</span><span class="S0"> </span><span class="S5">boolean</span><span class="S0"> </span>isRunning<span class="S10">()</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>stateLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S0"> </span>running<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Is the download cancelled?</span><br>
<span class="S3">&nbsp; &nbsp;  *</span><br>
<span class="S3">&nbsp; &nbsp;  * </span><span class="S18">@return</span><br>
<span class="S3">&nbsp; &nbsp;  * &nbsp;&nbsp;&nbsp;&nbsp;true if downloader is cancelled; false otherwise</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">public</span><span class="S0"> </span><span class="S5">boolean</span><span class="S0"> </span>isCancelled<span class="S10">()</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>stateLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S0"> </span>cancelled<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Is the download completed?</span><br>
<span class="S3">&nbsp; &nbsp;  *</span><br>
<span class="S3">&nbsp; &nbsp;  * </span><span class="S18">@return</span><br>
<span class="S3">&nbsp; &nbsp;  * &nbsp;&nbsp;&nbsp;&nbsp;true if download is completed; false otherwise</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">public</span><span class="S0"> </span><span class="S5">boolean</span><span class="S0"> </span>isCompleted<span class="S10">()</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>stateLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S0"> </span>completed<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Wait until the download is completed.</span><br>
<span class="S3">&nbsp; &nbsp;  * The target object should be accessed only after calling this method.</span><br>
<span class="S3">&nbsp; &nbsp;  *</span><br>
<span class="S3">&nbsp; &nbsp;  * </span><span class="S18">@throws</span><span class="S3"> Exception</span><br>
<span class="S3">&nbsp; &nbsp;  * &nbsp;&nbsp;&nbsp;&nbsp;if an error has occurred during download, or if the download was cancelled</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">public</span><span class="S0"> </span><span class="S5">void</span><span class="S0"> </span>waitUntilCompleted<span class="S10">()</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">throws</span><span class="S0"> </span>Exception<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">while</span><span class="S0"> </span><span class="S10">(</span>true<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>stateLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>completed<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>error<span class="S0"> </span><span class="S10">==</span><span class="S0"> </span><span class="S5">null</span><span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">else</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">throw</span><span class="S0"> </span>error<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>Debug<span class="S10">.</span>sleep<span class="S10">(</span>WAIT_INTERVAL_MILLISECONDS<span class="S10">);</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Start downloading the remote resource.</span><br>
<span class="S3">&nbsp; &nbsp;  * The target object should not be accessed until after calling waitUntilCompleted().</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">public</span><span class="S0"> </span><span class="S5">void</span><span class="S0"> </span>run<span class="S10">()</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>stateLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>started<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">else</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>started<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>running<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span>BufferedInputStream<span class="S0"> </span>bis<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S5">null</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span>BufferedOutputStream<span class="S0"> </span>bos<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S5">null</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span>BufferedReader<span class="S0"> </span>br<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S5">null</span><span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">try</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">/* open connection to the URL */</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>checkState<span class="S10">();</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressString<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S6">"Opening connection to remote resource"</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">final</span><span class="S0"> </span>URLConnection<span class="S0"> </span>link<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">try</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>link<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>url<span class="S10">.</span>openConnection<span class="S10">();</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>link<span class="S10">.</span>connect<span class="S10">();</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">catch</span><span class="S0"> </span><span class="S10">(</span>Exception<span class="S0"> </span>e<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressString<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S6">"Failed to open connection to remote resource"</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">throw</span><span class="S0"> </span>e<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">/* get length of the remote resource */</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>checkState<span class="S10">();</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressString<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S6">"Getting length of remote resource"</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">/* get size of webpage in bytes; -1 if unknown */</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">final</span><span class="S0"> </span><span class="S5">int</span><span class="S0"> </span>length<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>link<span class="S10">.</span>getContentLength<span class="S10">();</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>lengthLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>totalLength<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>length<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">/* open input stream to remote resource */</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>checkState<span class="S10">();</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressString<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S6">"Opening input stream to remote resource"</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">try</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">final</span><span class="S0"> </span>InputStream<span class="S0"> </span>input<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>link<span class="S10">.</span>getInputStream<span class="S10">();</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>target<span class="S0"> </span><span class="S5">instanceof</span><span class="S0"> </span>File<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>bis<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S5">new</span><span class="S0"> </span>BufferedInputStream<span class="S10">(</span>input<span class="S10">);</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">else</span><span class="S0"> </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>target<span class="S0"> </span><span class="S5">instanceof</span><span class="S0"> </span>StringBuilder<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">final</span><span class="S0"> </span>String<span class="S0"> </span>contentType<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>link<span class="S10">.</span>getContentType<span class="S10">().</span>toLowerCase<span class="S10">(</span>Locale<span class="S10">.</span>ENGLISH<span class="S10">);</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">/* look for charset, if specified */</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>String<span class="S0"> </span>charset<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S5">null</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">final</span><span class="S0"> </span>Matcher<span class="S0"> </span>m<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>Pattern<span class="S10">.</span>compile<span class="S10">(</span><span class="S6">".*charset[\\s]*=([^;]++).*"</span><span class="S10">).</span>matcher<span class="S10">(</span>contentType<span class="S10">);</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>m<span class="S10">.</span>find<span class="S10">())</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>charset<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>m<span class="S10">.</span>group<span class="S10">(</span><span class="S4">1</span><span class="S10">).</span>trim<span class="S10">();</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">((</span>charset<span class="S0"> </span><span class="S10">!=</span><span class="S0"> </span><span class="S5">null</span><span class="S10">)</span><span class="S0"> </span><span class="S10">&amp;&amp;</span><span class="S0"> </span><span class="S10">!</span>charset<span class="S10">.</span>isEmpty<span class="S10">())</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">try</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>br<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S5">new</span><span class="S0"> </span>BufferedReader<span class="S10">(</span><span class="S5">new</span><span class="S0"> </span>InputStreamReader<span class="S10">(</span>input<span class="S10">,</span><span class="S0"> </span>charset<span class="S10">));</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">catch</span><span class="S0"> </span><span class="S10">(</span>Exception<span class="S0"> </span>e<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>br<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S5">null</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>br<span class="S0"> </span><span class="S10">==</span><span class="S0"> </span><span class="S5">null</span><span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>br<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S5">new</span><span class="S0"> </span>BufferedReader<span class="S10">(</span><span class="S5">new</span><span class="S0"> </span>InputStreamReader<span class="S10">(</span>input<span class="S10">));</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">catch</span><span class="S0"> </span><span class="S10">(</span>Exception<span class="S0"> </span>e<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressString<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S6">"Failed to open input stream to remote resource"</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">throw</span><span class="S0"> </span>e<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">/* open output stream, if necessary */</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>target<span class="S0"> </span><span class="S5">instanceof</span><span class="S0"> </span>File<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>checkState<span class="S10">();</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressString<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S6">"Opening output stream to local file"</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">try</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">/* create parent directories, if necessary */</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">final</span><span class="S0"> </span>File<span class="S0"> </span>f<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S10">(</span>File<span class="S10">)</span><span class="S0"> </span>target<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">final</span><span class="S0"> </span>File<span class="S0"> </span>parent<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>f<span class="S10">.</span>getParentFile<span class="S10">();</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">((</span>parent<span class="S0"> </span><span class="S10">!=</span><span class="S0"> </span><span class="S5">null</span><span class="S10">)</span><span class="S0"> </span><span class="S10">&amp;&amp;</span><span class="S0"> </span><span class="S10">!</span>parent<span class="S10">.</span>exists<span class="S10">())</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>parent<span class="S10">.</span>mkdirs<span class="S10">();</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>bos<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S5">new</span><span class="S0"> </span>BufferedOutputStream<span class="S10">(</span><span class="S5">new</span><span class="S0"> </span>FileOutputStream<span class="S10">(</span>f<span class="S10">));</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">catch</span><span class="S0"> </span><span class="S10">(</span>Exception<span class="S0"> </span>e<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressString<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S6">"Failed to open output stream to local file"</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">throw</span><span class="S0"> </span>e<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">/* download remote resource iteratively */</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressString<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S6">"Downloading"</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">try</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>target<span class="S0"> </span><span class="S5">instanceof</span><span class="S0"> </span>File<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">final</span><span class="S0"> </span><span class="S5">byte</span><span class="S10">[]</span><span class="S0"> </span>byteBuffer<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S5">new</span><span class="S0"> </span><span class="S5">byte</span><span class="S10">[</span>BUFFER_SIZE<span class="S10">];</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">while</span><span class="S0"> </span><span class="S10">(</span>true<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>checkState<span class="S10">();</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">final</span><span class="S0"> </span><span class="S5">int</span><span class="S0"> </span>byteCount<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>bis<span class="S10">.</span>read<span class="S10">(</span>byteBuffer<span class="S10">,</span><span class="S0"> </span><span class="S4">0</span><span class="S10">,</span><span class="S0"> </span>BUFFER_SIZE<span class="S10">);</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">/* check for end-of-stream */</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>byteCount<span class="S0"> </span><span class="S10">==</span><span class="S0"> </span><span class="S10">-</span><span class="S4">1</span><span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">break</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>bos<span class="S10">.</span>write<span class="S10">(</span>byteBuffer<span class="S10">,</span><span class="S0"> </span><span class="S4">0</span><span class="S10">,</span><span class="S0"> </span>byteCount<span class="S10">);</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>lengthLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>downloadedLength<span class="S0"> </span><span class="S10">+=</span><span class="S0"> </span>byteCount<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">else</span><span class="S0"> </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>target<span class="S0"> </span><span class="S5">instanceof</span><span class="S0"> </span>StringBuilder<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">final</span><span class="S0"> </span><span class="S5">char</span><span class="S10">[]</span><span class="S0"> </span>charBuffer<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S5">new</span><span class="S0"> </span><span class="S5">char</span><span class="S10">[</span>BUFFER_SIZE<span class="S10">];</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">final</span><span class="S0"> </span>StringBuilder<span class="S0"> </span>sb<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S10">(</span>StringBuilder<span class="S10">)</span><span class="S0"> </span>target<span class="S10">;</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">while</span><span class="S0"> </span><span class="S10">(</span>true<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>checkState<span class="S10">();</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">final</span><span class="S0"> </span><span class="S5">int</span><span class="S0"> </span>charCount<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>br<span class="S10">.</span>read<span class="S10">(</span>charBuffer<span class="S10">,</span><span class="S0"> </span><span class="S4">0</span><span class="S10">,</span><span class="S0"> </span>BUFFER_SIZE<span class="S10">);</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">/* check for end-of-stream */</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>charCount<span class="S0"> </span><span class="S10">==</span><span class="S0"> </span><span class="S10">-</span><span class="S4">1</span><span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">break</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>sb<span class="S10">.</span>append<span class="S10">(</span>charBuffer<span class="S10">,</span><span class="S0"> </span><span class="S4">0</span><span class="S10">,</span><span class="S0"> </span>charCount<span class="S10">);</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>lengthLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>downloadedLength<span class="S0"> </span><span class="S10">+=</span><span class="S0"> </span>charCount<span class="S10">;</span><span class="S0"> </span><span class="S1">/* may be inaccurate because byte != char */</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">catch</span><span class="S0"> </span><span class="S10">(</span>Exception<span class="S0"> </span>e<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressString<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S6">"Failed to download remote resource"</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">throw</span><span class="S0"> </span>e<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">/* download completed successfully */</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressString<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S6">"Download completed"</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">catch</span><span class="S0"> </span><span class="S10">(</span>Exception<span class="S0"> </span>e<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>error<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>e<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">finally</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">/* clean-up */</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">for</span><span class="S0"> </span><span class="S10">(</span>Closeable<span class="S0"> </span>c<span class="S0"> </span><span class="S10">:</span><span class="S0"> </span><span class="S5">new</span><span class="S0"> </span>Closeable<span class="S10">[]</span><span class="S0"> </span><span class="S10">{</span>bis<span class="S10">,</span><span class="S0"> </span>br<span class="S10">,</span><span class="S0"> </span>bos<span class="S10">})</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>c<span class="S0"> </span><span class="S10">!=</span><span class="S0"> </span><span class="S5">null</span><span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">try</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>c<span class="S10">.</span>close<span class="S10">();</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">catch</span><span class="S0"> </span><span class="S10">(</span>Exception<span class="S0"> </span>e<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">/* ignore */</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>stateLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>running<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>false<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>completed<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S3">/**</span><br>
<span class="S3">&nbsp; &nbsp;  * Check if the downloader state has been modified.</span><br>
<span class="S3">&nbsp; &nbsp;  * This method blocks if the download has been paused, unless it is resumed or cancelled.</span><br>
<span class="S3">&nbsp; &nbsp;  * An exception is thrown if the download is cancelled.</span><br>
<span class="S3">&nbsp; &nbsp;  *</span><br>
<span class="S3">&nbsp; &nbsp;  * </span><span class="S18">@throws</span><span class="S3"> java.lang.Exception</span><br>
<span class="S3">&nbsp; &nbsp;  * &nbsp;&nbsp;&nbsp;&nbsp;if the download is cancelled</span><br>
<span class="S3">&nbsp; &nbsp;  */</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S5">private</span><span class="S0"> </span><span class="S5">void</span><span class="S0"> </span>checkState<span class="S10">()</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">throws</span><span class="S0"> </span>Exception<br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">while</span><span class="S0"> </span><span class="S10">(</span>true<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">synchronized</span><span class="S0"> </span><span class="S10">(</span>stateLock<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>cancelled<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressString<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S6">"Download cancelled"</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>progressUpdated<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>true<span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">throw</span><span class="S0"> </span><span class="S5">new</span><span class="S0"> </span>Exception<span class="S10">(</span><span class="S6">"Download cancelled"</span><span class="S10">);</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(</span>running<span class="S10">)</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">{</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S10">;</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>Debug<span class="S10">.</span>sleep<span class="S10">(</span>WAIT_INTERVAL_MILLISECONDS<span class="S10">);</span><br>
<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S0">&nbsp; &nbsp; </span><span class="S10">}</span><br>
<span class="S10">}</span></span>


</body></html>